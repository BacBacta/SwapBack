# üß™ Guide de Test Manuel - Buyback & Burn

**Date**: 25 Octobre 2025  
**Version**: 1.0  
**Environnement**: Devnet Solana

---

## üìã Pr√©-requis

### 1. Programs D√©ploy√©s
- [ ] `swapback_router` d√©ploy√© sur devnet
- [ ] `swapback_buyback` d√©ploy√© sur devnet
- [ ] Program IDs mis √† jour dans le code

### 2. Comptes Initialis√©s
- [ ] Router state initialis√©
- [ ] Buyback state initialis√© (min_buyback_amount = 100 USDC)
- [ ] USDC vault cr√©√©

### 3. Outils & Credentials
- [ ] Solana CLI install√© et configur√© pour devnet
- [ ] Wallet avec SOL pour les tests (min 2 SOL)
- [ ] Node.js + TypeScript configur√©
- [ ] SDK @swapback/sdk install√©

---

## üî¨ Test 1: V√©rification Programs

### Objectif
V√©rifier que les programs sont d√©ploy√©s et fonctionnels

### Commandes
```bash
# Router
solana program show 3Z295H9QHByYn9sHm3tH7ASHitwd2Y4AEaXUddfhQKap --url devnet

# Buyback
solana program show 46UWFYdksvkGhTPy9cTSJGa3d5nqzpY766rtJeuxtMgU --url devnet
```

### R√©sultats Attendus
- ‚úÖ Les deux programs existent
- ‚úÖ Upgradeable: Yes
- ‚úÖ Data Length: > 500 KB (chacun)

### Checklist
- [ ] Router program trouv√©
- [ ] Buyback program trouv√©
- [ ] Versions correctes

---

## üî¨ Test 2: V√©rification Buyback State

### Objectif
Lire le compte BuybackState on-chain

### Commandes
```bash
# Trouver le PDA
solana address --program-id 46UWFYdksvkGhTPy9cTSJGa3d5nqzpY766rtJeuxtMgU --seed buyback_state

# Lire le compte
solana account <BUYBACK_STATE_PDA> --url devnet --output json
```

### Script TypeScript
```typescript
import { getBuybackStats } from '@swapback/sdk';

const stats = await getBuybackStats(connection);
console.log('Min Buyback Amount:', stats.minBuybackAmount.toNumber() / 1e6, 'USDC');
console.log('Total USDC Spent:', stats.totalUsdcSpent.toNumber() / 1e6, 'USDC');
console.log('Total BACK Burned:', stats.totalBackBurned.toNumber() / 1e9, '$BACK');
console.log('Buyback Count:', stats.buybackCount.toNumber());
```

### R√©sultats Attendus
- ‚úÖ Account existe
- ‚úÖ `minBuybackAmount` = 100_000_000 (100 USDC)
- ‚úÖ `totalUsdcSpent` >= 0
- ‚úÖ `totalBackBurned` >= 0
- ‚úÖ `buybackCount` >= 0

### Checklist
- [ ] BuybackState trouv√©
- [ ] Authority correcte
- [ ] back_mint = $BACK mint
- [ ] usdc_vault PDA correct
- [ ] Stats initialis√©es √† 0

---

## üî¨ Test 3: V√©rification USDC Vault

### Objectif
V√©rifier que le vault USDC existe et peut recevoir des d√©p√¥ts

### Commandes
```bash
# Trouver le PDA
solana address --program-id 46UWFYdksvkGhTPy9cTSJGa3d5nqzpY766rtJeuxtMgU --seed usdc_vault

# Balance
spl-token balance EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v --owner <USDC_VAULT_PDA> --url devnet
```

### Script TypeScript
```typescript
const [usdcVaultPDA] = getUsdcVaultPDA();
const balance = await connection.getTokenAccountBalance(usdcVaultPDA);
console.log('USDC Vault Balance:', balance.value.uiAmount, 'USDC');
```

### R√©sultats Attendus
- ‚úÖ Token Account existe
- ‚úÖ Mint = USDC (EPjFWdd...)
- ‚úÖ Owner = Buyback State PDA
- ‚úÖ Balance >= 0

### Checklist
- [ ] USDC vault trouv√©
- [ ] Owner correct (buyback_state PDA)
- [ ] Balance lisible

---

## üî¨ Test 4: Simulation Swap avec Router

### Objectif
Calculer les montants qui seraient envoy√©s au buyback lors d'un swap

### Sc√©nario
```
Input:  1 SOL
Output: 150 USDC (prix mock)
Min:    145 USDC (slippage 3%)
```

### Calculs Attendus
```
Platform Fee (0.3%):     150 * 0.003 = 0.45 USDC
Routing Profit:          150 - 145 - 0.45 = 4.55 USDC

Allocation Buyback (40%):
  From fee:    0.45 * 0.40 = 0.18 USDC
  From profit: 4.55 * 0.40 = 1.82 USDC
  
TOTAL BUYBACK DEPOSIT: 2.00 USDC
```

### Script Test
```typescript
const amountIn = 1 * LAMPORTS_PER_SOL;
const amountOut = 150 * 1e6;
const minOut = 145 * 1e6;

const platformFee = Math.floor(amountOut * 30 / 10000); // 0.3%
const routingProfit = amountOut - minOut - platformFee;
const buybackDeposit = Math.floor(platformFee * 0.4) + Math.floor(routingProfit * 0.4);

console.log('Buyback Deposit:', buybackDeposit / 1e6, 'USDC');
// Expected: ~2.00 USDC
```

### Checklist
- [ ] Platform fee = 0.3% correct
- [ ] Routing profit calcul√© correctement
- [ ] 40% allocation v√©rifi√©e
- [ ] Total buyback deposit = 2.00 USDC

---

## üî¨ Test 5: Execute Swap R√©el (Devnet)

‚ö†Ô∏è **ATTENTION**: N√©cessite des tokens SOL et routing fonctionnel

### Pr√©-requis
- Avoir au moins 2 SOL sur devnet
- Router program fonctionnel avec DEX integration

### √âtapes
1. Pr√©parer les comptes token
2. Approuver le router
3. Ex√©cuter swap
4. V√©rifier event logs
5. V√©rifier USDC vault balance

### Commande (via SDK)
```typescript
import { SwapExecutor } from '@swapback/sdk';

const result = await swapExecutor.executeSwap({
  inputToken: SOL_MINT,
  outputToken: USDC_MINT,
  amount: 1 * LAMPORTS_PER_SOL,
  slippage: 300, // 3%
  user: userKeypair,
});

console.log('Swap signature:', result.signature);
console.log('Amount out:', result.amountOut / 1e6, 'USDC');
```

### V√©rification Events
```bash
solana confirm -v <SIGNATURE> --url devnet | grep -A 10 "SwapCompleted"
```

### R√©sultats Attendus (Events)
```
SwapCompleted {
  user: <USER_PUBKEY>,
  amount_in: 1000000000,      // 1 SOL
  amount_out: 150000000,      // 150 USDC
  platform_fee: 450000,       // 0.45 USDC
  routing_profit: 4550000,    // 4.55 USDC
  buyback_deposit: 2000000    // 2.00 USDC
}

BuybackDeposit {
  amount: 2000000,            // 2.00 USDC
  source: "swap_fees_and_profit",
  timestamp: <UNIX_TIME>
}
```

### Checklist
- [ ] Swap ex√©cut√© avec succ√®s
- [ ] Event SwapCompleted √©mis
- [ ] Event BuybackDeposit √©mis
- [ ] buyback_deposit = ~2.00 USDC
- [ ] USDC vault balance augment√© de 2.00 USDC

---

## üî¨ Test 6: V√©rifier Deposit dans Vault

### Objectif
Confirmer que les USDC ont bien √©t√© transf√©r√©s au vault

### Avant/Apr√®s Swap
```typescript
// BEFORE
const balanceBefore = await connection.getTokenAccountBalance(usdcVaultPDA);
console.log('Before:', balanceBefore.value.uiAmount, 'USDC');

// EXECUTE SWAP
await executeSwap(...);

// AFTER
const balanceAfter = await connection.getTokenAccountBalance(usdcVaultPDA);
console.log('After:', balanceAfter.value.uiAmount, 'USDC');

const difference = balanceAfter.value.uiAmount - balanceBefore.value.uiAmount;
console.log('Deposited:', difference, 'USDC');
// Expected: ~2.00 USDC
```

### R√©sultats Attendus
- ‚úÖ Balance augment√©e exactement du montant `buyback_deposit`
- ‚úÖ Aucune perte de precision (lamports)

### Checklist
- [ ] Vault balance augment√©
- [ ] Montant exact = buyback_deposit
- [ ] Pas de lamports perdus

---

## üî¨ Test 7: Estimation Prochain Buyback

### Objectif
V√©rifier que l'estimation fonctionne correctement

### Script
```typescript
import { estimateNextBuyback } from '@swapback/sdk';

const estimation = await estimateNextBuyback(connection);

console.log('USDC Available:', estimation.usdcAvailable, 'USDC');
console.log('Estimated $BACK:', estimation.estimatedBackAmount);
console.log('Can Execute:', estimation.canExecute);
console.log('Reason:', estimation.reason);
```

### Sc√©narios
| Vault Balance | Can Execute | Reason |
|---------------|-------------|--------|
| 0 USDC | ‚ùå | Need 100 USDC minimum |
| 50 USDC | ‚ùå | Need 100 USDC minimum (current: 50) |
| 100 USDC | ‚úÖ | - |
| 500 USDC | ‚úÖ | - |

### Checklist
- [ ] Estimation retourne balance correcte
- [ ] canExecute = false si < 100 USDC
- [ ] canExecute = true si >= 100 USDC
- [ ] estimatedBackAmount calcul√© (1 USDC = ~250 $BACK)

---

## üî¨ Test 8: Execute Buyback (Admin)

‚ö†Ô∏è **ATTENTION**: N√©cessite authority du buyback program

### Pr√©-requis
- USDC vault >= 100 USDC
- Admin keypair avec authority
- Jupiter disponible sur devnet

### Script
```typescript
import { executeBuyback } from '@swapback/sdk';

const signature = await executeBuyback(
  connection,
  adminKeypair,
  500_000_000,  // Max 500 USDC
  125_000_000_000  // Min 125,000 $BACK
);

console.log('Buyback executed:', signature);
```

### V√©rification Events
```bash
solana confirm -v <SIGNATURE> --url devnet
```

### R√©sultats Attendus (Events)
```
BuybackExecuted {
  usdc_amount: 500000000,           // 500 USDC
  back_amount: 125000000000,        // 125,000 $BACK
  timestamp: <UNIX_TIME>
}

BackBurned {
  amount: 125000000000,             // 125,000 $BACK
  total_burned: 125000000000,       // Total cumul√©
  timestamp: <UNIX_TIME>
}
```

### Checklist
- [ ] Transaction r√©ussie
- [ ] Event BuybackExecuted √©mis
- [ ] Event BackBurned √©mis
- [ ] USDC vault balance r√©duit
- [ ] BuybackState mis √† jour

---

## üî¨ Test 9: V√©rifier Stats Apr√®s Buyback

### Objectif
Confirmer que toutes les stats ont √©t√© mises √† jour

### Script
```typescript
const statsAfter = await getBuybackStats(connection);

console.log('Total USDC Spent:', statsAfter.totalUsdcSpent.toNumber() / 1e6, 'USDC');
console.log('Total BACK Burned:', statsAfter.totalBackBurned.toNumber() / 1e9, '$BACK');
console.log('Buyback Count:', statsAfter.buybackCount.toNumber());
```

### R√©sultats Attendus
- ‚úÖ `totalUsdcSpent` augment√© de 500 USDC
- ‚úÖ `totalBackBurned` augment√© de 125,000 $BACK
- ‚úÖ `buybackCount` augment√© de 1

### Checklist
- [ ] totalUsdcSpent mis √† jour
- [ ] totalBackBurned mis √† jour
- [ ] buybackCount incr√©ment√©
- [ ] Vault balance = 0 (si tout utilis√©)

---

## üî¨ Test 10: Frontend Dashboard

### Objectif
V√©rifier que le dashboard affiche correctement les stats

### URL
http://localhost:3001/dashboard

### √âl√©ments √† V√©rifier
- [ ] Section "üî• BUYBACK & BURN" visible
- [ ] **USDC Spent**: Affiche le total correct
- [ ] **$BACK Burned**: Affiche le total correct
- [ ] **Buybacks Executed**: Affiche le count correct
- [ ] **Vault Balance**: Affiche balance actuelle
- [ ] **Next Buyback Estimate**: Status Ready/Pending correct
- [ ] Auto-refresh fonctionne (30s)
- [ ] Bouton refresh manuel fonctionne
- [ ] Live indicator anim√©

### Screenshots
Prendre des screenshots pour documentation :
1. Dashboard overview
2. Buyback stats card
3. Next buyback estimate (Ready state)
4. Next buyback estimate (Pending state)

---

## üìä R√©sultats de Test - Template

```
Date: _____________
Testeur: _____________
Environnement: Devnet

‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                    R√âSULTATS DE TEST                          ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

Test 1: Programs D√©ploy√©s          [ ] Pass  [ ] Fail
Test 2: Buyback State               [ ] Pass  [ ] Fail
Test 3: USDC Vault                  [ ] Pass  [ ] Fail
Test 4: Simulation Swap             [ ] Pass  [ ] Fail
Test 5: Execute Swap R√©el           [ ] Pass  [ ] Fail
Test 6: V√©rifier Deposit            [ ] Pass  [ ] Fail
Test 7: Estimation Buyback          [ ] Pass  [ ] Fail
Test 8: Execute Buyback             [ ] Pass  [ ] Fail
Test 9: V√©rifier Stats              [ ] Pass  [ ] Fail
Test 10: Frontend Dashboard         [ ] Pass  [ ] Fail

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

TAUX DE R√âUSSITE: ___/10 (___%)

PROBL√àMES RENCONTR√âS:
_________________________________________________________________
_________________________________________________________________
_________________________________________________________________

NOTES:
_________________________________________________________________
_________________________________________________________________
_________________________________________________________________
```

---

## üêõ Troubleshooting

### Erreur: "Buyback state not found"
**Solution**: Ex√©cuter initialize_buyback instruction avec admin authority

### Erreur: "Insufficient funds in vault"
**Solution**: Faire plus de swaps pour accumuler USDC, ou r√©duire min_buyback_amount

### Erreur: "Jupiter swap failed"
**Solution**: V√©rifier que Jupiter est disponible sur devnet, augmenter slippage

### Erreur: "Slippage exceeded"
**Solution**: Augmenter slippage dans execute_buyback (actuellement 0.5%)

### Erreur: "Invalid authority"
**Solution**: Utiliser le bon keypair admin pour execute_buyback

### Frontend ne charge pas les stats
**Solution**: V√©rifier RPC connection, v√©rifier que buyback_state existe

---

## üìà M√©triques de Succ√®s

### Crit√®res de Validation
- ‚úÖ **Tous les tests passent** (10/10)
- ‚úÖ **Aucune perte de fonds** (USDC, SOL, $BACK)
- ‚úÖ **Events corrects** √©mis √† chaque √©tape
- ‚úÖ **Stats on-chain coh√©rentes**
- ‚úÖ **Frontend synchronis√©** avec on-chain

### KPIs √† Tracker
| M√©trique | Cible | Actuel | Status |
|----------|-------|--------|--------|
| Frais collect√©s | 0.30% | ___ % | ___ |
| Allocation buyback | 40% | ___ % | ___ |
| Slippage buyback | < 0.5% | ___ % | ___ |
| Burn accuracy | 100% | ___ % | ___ |
| Dashboard uptime | 99% | ___ % | ___ |

---

## üöÄ Prochaines √âtapes

Apr√®s validation compl√®te des tests :

1. **Audit Code**
   - Review par autre dev
   - Security audit si possible

2. **Tests de Charge**
   - 100 swaps cons√©cutifs
   - V√©rifier gas costs
   - V√©rifier performance

3. **Documentation**
   - Mettre √† jour README
   - Cr√©er guide utilisateur
   - Vid√©o d√©mo

4. **Mainnet Prep**
   - Deploy sur mainnet-beta
   - Initialize avec vrais tokens
   - Monitoring setup

---

**Version**: 1.0  
**Derni√®re Mise √† Jour**: 25 Octobre 2025  
**Auteur**: GitHub Copilot
