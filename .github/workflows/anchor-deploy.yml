name: Deploy with Anchor CLI (Fix Cargo.lock v4)

on:
  workflow_dispatch:
    inputs:
      program_name:
        description: 'Programme Ã  dÃ©ployer'
        required: true
        default: 'swapback_cnft'
        type: choice
        options:
          - swapback_cnft
          - swapback_router

env:
  SOLANA_VERSION: v1.18.26
  ANCHOR_VERSION: v0.30.1

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain (1.75.0 - Last stable with v3 support)
        uses: dtolnay/rust-toolchain@1.75.0
        with:
          components: rustfmt, clippy

      - name: Configure Cargo to use stable resolver (prevent v4)
        run: |
          echo "ğŸ”§ Configuring Cargo for Cargo.lock v3..."
          
          # Force Cargo to use stable resolver (not nightly v4)
          export CARGO_RESOLVER_INCOMPATIBLE_RUST_VERSIONS=fallback
          echo "CARGO_RESOLVER_INCOMPATIBLE_RUST_VERSIONS=fallback" >> $GITHUB_ENV
          
          echo "Rust version: $(rustc --version)"
          echo "Cargo version: $(cargo --version)"

      - name: NO CACHE - Fresh build every time
        run: |
          echo "âš ï¸ Cache DISABLED to prevent Cargo.lock v4 restoration"
          echo "Building fresh every time to guarantee Cargo.lock v3"

      - name: NUCLEAR - Remove ALL Cargo.lock files
        run: |
          echo "ğŸ”¥ Obliterating all Cargo.lock files..."
          find . -name "Cargo.lock" -type f -print -delete 2>/dev/null || true
          rm -f Cargo.lock 2>/dev/null || true
          git rm --cached -f Cargo.lock 2>/dev/null || true
          git rm --cached -f "**/Cargo.lock" 2>/dev/null || true
          
          REMAINING=$(find . -name "Cargo.lock" -type f 2>/dev/null | wc -l)
          if [ "$REMAINING" -gt 0 ]; then
            echo "âŒ $REMAINING Cargo.lock files remain"
            exit 1
          fi
          echo "âœ… All Cargo.lock obliterated"

      - name: Generate Cargo.lock v3 with Rust 1.75.0
        run: |
          echo "ğŸ”§ Generating Cargo.lock v3 with Rust 1.75.0..."
          echo "Rust version: $(rustc --version)"
          echo "Cargo version: $(cargo --version)"
          
          # Generate Cargo.lock
          cargo generate-lockfile
          
          # Verify version
          echo ""
          echo "Generated Cargo.lock:"
          head -5 Cargo.lock
          
          LOCK_VERSION=$(head -5 Cargo.lock | grep "version = " | grep -oE '[0-9]+' || echo "3")
          echo ""
          echo "Detected version: $LOCK_VERSION"
          
          if [ "$LOCK_VERSION" = "4" ]; then
            echo "âš ï¸ WARNING: Generated v4, converting to v3..."
            rm -f Cargo.lock
            
            # Force v3 by setting environment
            CARGO_RESOLVER_PRECEDENCE=rust-version cargo generate-lockfile
            
            LOCK_VERSION=$(head -5 Cargo.lock | grep "version" | grep -oE '[0-9]+' || echo "3")
            if [ "$LOCK_VERSION" = "4" ]; then
              echo "âŒ Still v4, but continuing (may work with anchor build)"
            fi
          fi
          
          echo "âœ… Cargo.lock generated (version $LOCK_VERSION)"

      - name: Install Solana CLI (GitHub releases - reliable)
        run: |
          echo "ğŸ“¦ Installing Solana CLI ${{ env.SOLANA_VERSION }}..."
          
          # Use GitHub releases directly (more reliable than release.solana.com)
          VERSION_NUM="${{ env.SOLANA_VERSION }}"
          
          echo "Downloading from GitHub releases..."
          wget https://github.com/solana-labs/solana/releases/download/${VERSION_NUM}/solana-release-x86_64-unknown-linux-gnu.tar.bz2 -O solana.tar.bz2 || {
            echo "âš ï¸ ${VERSION_NUM} unavailable, trying v1.18.18..."
            wget https://github.com/solana-labs/solana/releases/download/v1.18.18/solana-release-x86_64-unknown-linux-gnu.tar.bz2 -O solana.tar.bz2 || {
              echo "âŒ Download failed"
              exit 1
            }
          }
          
          echo "Extracting..."
          tar xjf solana.tar.bz2
          
          echo "Installing to ~/.local/share/solana..."
          mkdir -p $HOME/.local/share/solana/install/active_release
          cp -r solana-release/* $HOME/.local/share/solana/install/active_release/
          
          echo "Cleaning up..."
          rm -rf solana-release solana.tar.bz2
          
          echo "Adding to PATH..."
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          
          echo "Verifying installation..."
          solana --version
          solana-keygen --version
          echo "âœ… Solana CLI installed successfully"

      - name: Install Anchor CLI v0.30.1 (direct from tag)
        run: |
          echo "ğŸ“¦ Installing Anchor CLI ${{ env.ANCHOR_VERSION }}..."
          
          # Install directly from git tag (not avm)
          cargo install --git https://github.com/coral-xyz/anchor \
            --tag ${{ env.ANCHOR_VERSION }} \
            anchor-cli \
            --locked \
            --force
          
          anchor --version
          echo "âœ… Anchor CLI ${{ env.ANCHOR_VERSION }} installed"

      - name: Configure Solana
        run: |
          solana config set --url devnet
          echo "${{ secrets.DEPLOYER_PRIVATE_KEY }}" > deployer-keypair.json
          solana config set --keypair deployer-keypair.json
          
          PUBKEY=$(solana address)
          echo "ğŸ’¼ Deployer: $PUBKEY"
          
          BALANCE=$(solana balance --url devnet | grep -oE '[0-9]+\.[0-9]+' | head -n1 || echo "0")
          echo "ğŸ’° Balance: $BALANCE SOL"
          
          if (( $(echo "$BALANCE < 1.0" | bc -l) )); then
            echo "âš ï¸ Low balance, requesting airdrop..."
            solana airdrop 2 --url devnet || echo "Airdrop failed, continuing..."
          fi

      - name: Verify declare_id!
        run: |
          PROGRAM_ID="${{ github.event.inputs.program_name == 'swapback_cnft' && '26kzow1KF3AbrbFA7M3WxXVCtcMRgzMXkAKtVYDDt6Ru' || 'opPhGcth2dGQQ7njYmkAYwfxspJ1DjgP9LV2y1jygCx' }}"
          
          CURRENT_ID=$(grep -A1 "declare_id!" programs/${{ github.event.inputs.program_name }}/src/lib.rs | grep -oE '[A-Za-z0-9]{32,}' | head -1)
          
          if [ "$CURRENT_ID" != "$PROGRAM_ID" ]; then
            echo "âŒ declare_id! mismatch!"
            echo "Expected: $PROGRAM_ID"
            echo "Found: $CURRENT_ID"
            exit 1
          fi
          
          echo "âœ… declare_id! correct: $CURRENT_ID"

      - name: Pre-build Cargo.lock check
        run: |
          echo "ğŸ” Final pre-build check..."
          
          if [ ! -f "Cargo.lock" ]; then
            echo "âŒ Cargo.lock v3 not found! Should have been generated."
            exit 1
          fi
          
          # Verify it's version 3
          LOCK_VERSION=$(head -5 Cargo.lock | grep "version" | grep -oE '[0-9]+')
          if [ "$LOCK_VERSION" != "3" ]; then
            echo "âŒ Cargo.lock is version $LOCK_VERSION, expected 3"
            head -10 Cargo.lock
            exit 1
          fi
          
          echo "âœ… Cargo.lock v3 confirmed:"
          head -5 Cargo.lock

      - name: Build with Anchor
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”¨ BUILDING: ${{ github.event.inputs.program_name }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Build with Anchor
          set +e
          anchor build --program-name ${{ github.event.inputs.program_name }} 2>&1 | tee build.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          # Check for Cargo.lock v4 error
          if grep -q "lock file version 4 requires" build.log; then
            echo "âŒ CARGO.LOCK VERSION 4 ERROR"
            grep -A10 -B5 "lock file version 4" build.log
            exit 1
          fi
          
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "âŒ BUILD FAILED (Exit code: $BUILD_EXIT_CODE)"
            tail -200 build.log
            exit $BUILD_EXIT_CODE
          fi
          
          echo "âœ… BUILD SUCCESSFUL"

      - name: Verify build artifacts
        run: |
          SO_FILE="target/deploy/${{ github.event.inputs.program_name }}.so"
          KEYPAIR_FILE="target/deploy/${{ github.event.inputs.program_name }}-keypair.json"
          
          if [ ! -f "$SO_FILE" ]; then
            echo "âŒ Binary not found: $SO_FILE"
            exit 1
          fi
          
          if [ ! -f "$KEYPAIR_FILE" ]; then
            echo "âŒ Keypair not found: $KEYPAIR_FILE"
            exit 1
          fi
          
          echo "âœ… Binary: $SO_FILE ($(du -h $SO_FILE | cut -f1))"
          echo "âœ… Keypair: $KEYPAIR_FILE"
          
          PROGRAM_ID=$(solana-keygen pubkey $KEYPAIR_FILE)
          echo "ğŸ“Œ Program ID: $PROGRAM_ID"

      - name: Deploy to devnet
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ DEPLOYING: ${{ github.event.inputs.program_name }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          PROGRAM_ID="${{ github.event.inputs.program_name == 'swapback_cnft' && '26kzow1KF3AbrbFA7M3WxXVCtcMRgzMXkAKtVYDDt6Ru' || 'opPhGcth2dGQQ7njYmkAYwfxspJ1DjgP9LV2y1jygCx' }}"
          
          solana program deploy \
            target/deploy/${{ github.event.inputs.program_name }}.so \
            --program-id target/deploy/${{ github.event.inputs.program_name }}-keypair.json \
            --url devnet \
            --upgrade-authority deployer-keypair.json \
            --max-retries 10 \
            --use-rpc \
            2>&1 | tee deploy.log
          
          if grep -q "successfully" deploy.log; then
            echo "âœ… DEPLOYMENT SUCCESSFUL"
          else
            echo "âŒ DEPLOYMENT FAILED"
            cat deploy.log
            exit 1
          fi

      - name: Verify deployment
        run: |
          PROGRAM_ID="${{ github.event.inputs.program_name == 'swapback_cnft' && '26kzow1KF3AbrbFA7M3WxXVCtcMRgzMXkAKtVYDDt6Ru' || 'opPhGcth2dGQQ7njYmkAYwfxspJ1DjgP9LV2y1jygCx' }}"
          
          echo "ğŸ” Verifying deployment..."
          solana program show $PROGRAM_ID --url devnet
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… DEPLOYMENT COMPLETE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Program ID: $PROGRAM_ID"
          echo "Network: Devnet"
          echo ""
          echo "Test on Vercel:"
          echo "https://swap-back-pc5qkn6em-bactas-projects.vercel.app/"
