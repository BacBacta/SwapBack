name: Deploy with Anchor v0.30.1 (Solana 1.18.26 + Rust 1.75.0)

on:
  workflow_dispatch:
    inputs:
      program_name:
        description: 'Programme Ã  dÃ©ployer'
        required: true
        default: 'swapback_cnft'
        type: choice
        options:
          - swapback_cnft
          - swapback_router

env:
  SOLANA_VERSION: v1.18.26
  ANCHOR_VERSION: 0.30.1

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust 1.75.0 (Last version generating Cargo.lock v3)
        uses: dtolnay/rust-toolchain@1.75.0
        with:
          components: rustfmt, clippy

      - name: Verify Rust version
        run: |
          echo "âœ… Using Rust 1.75.0 (generates Cargo.lock v3)"
          echo "âš ï¸ Solana 1.18.26 requires Cargo.lock v3"
          rustc --version
          cargo --version

      - name: Generate Cargo.lock v3 (REQUIRED by Solana 1.18.26)
        run: |
          echo "ğŸ”§ CRITICAL: Solana CLI 1.18.26 requires Cargo.lock v3"
          echo "Using Rust 1.75.0 to generate v3"
          echo "Rust: $(rustc --version)"
          echo "Cargo: $(cargo --version)"
          
          # Delete any existing lockfile
          rm -f Cargo.lock
          
          # Generate with Rust 1.75.0 (produces v3)
          cargo generate-lockfile
          
          # Verify version
          LOCK_VERSION=$(head -5 Cargo.lock | grep "version = " | grep -oE '[0-9]+' || echo "unknown")
          echo "Generated Cargo.lock version: $LOCK_VERSION"
          
          if [ "$LOCK_VERSION" != "3" ]; then
            echo "âŒ ERROR: Expected v3 but got v$LOCK_VERSION"
            echo "Forcing v3..."
            sed -i 's/^version = [0-9]\+$/version = 3/' Cargo.lock
            
            LOCK_VERSION=$(head -5 Cargo.lock | grep "version = " | grep -oE '[0-9]+')
            if [ "$LOCK_VERSION" != "3" ]; then
              echo "âŒ Failed to force v3"
              exit 1
            fi
          fi
          
          echo "âœ… Cargo.lock v3 ready (Solana 1.18.26 compatible)"

      - name: Install Solana CLI ${{ env.SOLANA_VERSION }}
        run: |
          echo "ğŸ“¦ Installing Solana CLI ${{ env.SOLANA_VERSION }}..."
          
          # Try GitHub releases first
          if wget -q --spider "https://github.com/solana-labs/solana/releases/download/${{ env.SOLANA_VERSION }}/solana-release-x86_64-unknown-linux-gnu.tar.bz2"; then
            echo "Downloading from GitHub releases..."
            wget -q https://github.com/solana-labs/solana/releases/download/${{ env.SOLANA_VERSION }}/solana-release-x86_64-unknown-linux-gnu.tar.bz2 -O solana.tar.bz2
          else
            echo "âš ï¸ GitHub release not found, using stable channel..."
            wget -q https://release.solana.com/v1.18.26/solana-release-x86_64-unknown-linux-gnu.tar.bz2 -O solana.tar.bz2 || {
              echo "âŒ Download failed"
              exit 1
            }
          fi
          
          echo "Extracting..."
          tar xjf solana.tar.bz2
          
          echo "Installing to ~/.local/share/solana..."
          mkdir -p $HOME/.local/share/solana/install/active_release
          cp -r solana-release/* $HOME/.local/share/solana/install/active_release/
          
          echo "Cleaning up..."
          rm -rf solana-release solana.tar.bz2
          
          echo "Adding to PATH..."
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          
          echo "Verifying installation..."
          solana --version
          solana-keygen --version
          echo "âœ… Solana CLI installed successfully"

      - name: Install Anchor CLI v0.30.1 (compatible with Rust 1.75.0 and Solana 1.18.26)
        run: |
          echo "ğŸ“¦ Installing Anchor CLI v0.30.1 (compatible with Rust 1.75.0)..."

          # Install Anchor Version Manager so the CLI can manage versions cleanly
          cargo install avm --locked --force

          # Install and activate the required Anchor CLI version via avm
          avm install ${{ env.ANCHOR_VERSION }}
          avm use ${{ env.ANCHOR_VERSION }}

          # Ensure avm-managed binaries are on PATH for all subsequent steps
          echo "$HOME/.local/share/avm/bin" >> $GITHUB_PATH
          export PATH="$HOME/.local/share/avm/bin:$PATH"

          anchor --version
          avm list
          echo "âœ… Anchor CLI v${{ env.ANCHOR_VERSION }} installed via avm"

          # Disable avm auto-upgrade attempts during builds
          echo "ANCHOR_SKIP_VERSION_CHECK=1" >> $GITHUB_ENV



      - name: Configure Solana
        run: |
          solana config set --url devnet
          echo "${{ secrets.DEPLOYER_PRIVATE_KEY }}" > deployer-keypair.json
          solana config set --keypair deployer-keypair.json
          
          PUBKEY=$(solana address)
          echo "ğŸ’¼ Deployer: $PUBKEY"
          
          BALANCE=$(solana balance --url devnet | grep -oE '[0-9]+\.[0-9]+' | head -n1 || echo "0")
          echo "ğŸ’° Balance: $BALANCE SOL"
          
          if (( $(echo "$BALANCE < 1.0" | bc -l) )); then
            echo "âš ï¸ Low balance, requesting airdrop..."
            solana airdrop 2 --url devnet || echo "Airdrop failed, continuing..."
          fi

      - name: Verify declare_id!
        run: |
          PROGRAM_ID="${{ github.event.inputs.program_name == 'swapback_cnft' && '26kzow1KF3AbrbFA7M3WxXVCtcMRgzMXkAKtVYDDt6Ru' || 'opPhGcth2dGQQ7njYmkAYwfxspJ1DjgP9LV2y1jygCx' }}"
          
          CURRENT_ID=$(grep -A1 "declare_id!" programs/${{ github.event.inputs.program_name }}/src/lib.rs | grep -oE '[A-Za-z0-9]{32,}' | head -1)
          
          if [ "$CURRENT_ID" != "$PROGRAM_ID" ]; then
            echo "âŒ declare_id! mismatch!"
            echo "Expected: $PROGRAM_ID"
            echo "Found: $CURRENT_ID"
            exit 1
          fi
          
          echo "âœ… declare_id! correct: $CURRENT_ID"

      - name: Pre-build verification
        run: |
          echo "ğŸ” Verifying Cargo.lock v3 (REQUIRED by Solana 1.18.26)..."
          
          if [ ! -f "Cargo.lock" ]; then
            echo "âŒ Cargo.lock not found!"
            exit 1
          fi
          
          LOCK_VERSION=$(head -5 Cargo.lock | grep "version = " | grep -oE '[0-9]+')
          echo "Cargo.lock version: $LOCK_VERSION"
          
          if [ "$LOCK_VERSION" != "3" ]; then
            echo "âŒ INVALID: Solana 1.18.26 requires v3, found v$LOCK_VERSION"
            echo "Current Cargo.lock header:"
            head -10 Cargo.lock
            exit 1
          fi
          
          echo "âœ… Cargo.lock v3 confirmed"
          echo "ğŸ“¦ Ready to build with Solana 1.18.26"

      - name: Build with Anchor
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”¨ BUILDING: ${{ github.event.inputs.program_name }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Build with Anchor
          set +e
          anchor build --program-name ${{ github.event.inputs.program_name }} 2>&1 | tee build.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          # Check for Cargo.lock errors (should not happen with Solana 2.0)
          if grep -q "lock file version" build.log; then
            echo "âŒ CARGO.LOCK VERSION ERROR"
            grep -A10 -B5 "lock file version" build.log
            exit 1
          fi
          
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "âŒ BUILD FAILED (Exit code: $BUILD_EXIT_CODE)"
            tail -200 build.log
            exit $BUILD_EXIT_CODE
          fi
          
          echo "âœ… BUILD SUCCESSFUL"

      - name: Verify build artifacts
        run: |
          SO_FILE="target/deploy/${{ github.event.inputs.program_name }}.so"
          KEYPAIR_FILE="target/deploy/${{ github.event.inputs.program_name }}-keypair.json"
          
          if [ ! -f "$SO_FILE" ]; then
            echo "âŒ Binary not found: $SO_FILE"
            exit 1
          fi
          
          if [ ! -f "$KEYPAIR_FILE" ]; then
            echo "âŒ Keypair not found: $KEYPAIR_FILE"
            exit 1
          fi
          
          echo "âœ… Binary: $SO_FILE ($(du -h $SO_FILE | cut -f1))"
          echo "âœ… Keypair: $KEYPAIR_FILE"
          
          PROGRAM_ID=$(solana-keygen pubkey $KEYPAIR_FILE)
          echo "ğŸ“Œ Program ID: $PROGRAM_ID"

      - name: Deploy to devnet
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ DEPLOYING: ${{ github.event.inputs.program_name }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          PROGRAM_ID="${{ github.event.inputs.program_name == 'swapback_cnft' && '26kzow1KF3AbrbFA7M3WxXVCtcMRgzMXkAKtVYDDt6Ru' || 'opPhGcth2dGQQ7njYmkAYwfxspJ1DjgP9LV2y1jygCx' }}"
          
          solana program deploy \
            target/deploy/${{ github.event.inputs.program_name }}.so \
            --program-id target/deploy/${{ github.event.inputs.program_name }}-keypair.json \
            --url devnet \
            --upgrade-authority deployer-keypair.json \
            --max-retries 10 \
            --use-rpc \
            2>&1 | tee deploy.log
          
          if grep -q "successfully" deploy.log; then
            echo "âœ… DEPLOYMENT SUCCESSFUL"
          else
            echo "âŒ DEPLOYMENT FAILED"
            cat deploy.log
            exit 1
          fi

      - name: Verify deployment
        run: |
          PROGRAM_ID="${{ github.event.inputs.program_name == 'swapback_cnft' && '26kzow1KF3AbrbFA7M3WxXVCtcMRgzMXkAKtVYDDt6Ru' || 'opPhGcth2dGQQ7njYmkAYwfxspJ1DjgP9LV2y1jygCx' }}"
          
          echo "ğŸ” Verifying deployment..."
          solana program show $PROGRAM_ID --url devnet
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… DEPLOYMENT COMPLETE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Program ID: $PROGRAM_ID"
          echo "Network: Devnet"
          echo ""
          echo "Test on Vercel:"
          echo "https://swap-back-pc5qkn6em-bactas-projects.vercel.app/"
