name: Deploy Solana Program to Devnet

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Set up Rust toolchain (optional, ensures reproducible toolchain for workspace)
        uses: actions-rs/toolchain@v1
        with:
          toolchain: 1.70.0
          override: true
          profile: minimal

      - name: Remove any repository root Cargo.lock (avoid Cargo.lock v4 parsing error in CI)
        run: |
          echo "Listing Cargo.lock files before deletion (for debug):"
          find . -name Cargo.lock -type f -maxdepth 4 -print || true
          # Delete root/workspace Cargo.lock files that break cargo-build-sbf
          find . -name Cargo.lock -type f -maxdepth 4 -exec rm -f {} \; || true
          echo "Deleted candidate Cargo.lock files. Verify none remain:"
          find . -name Cargo.lock -type f -print || echo "No Cargo.lock files found"

      - name: Pull Solana CLI Docker image
        run: |
          docker pull solanalabs/solana:v1.18.18

      - name: Build Solana program(s) inside Solana Docker image
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          set -euo pipefail
          # ensure workspace permissions for docker
          ls -la "${GITHUB_WORKSPACE}" || true

          docker run --rm \
            -v "${GITHUB_WORKSPACE}":/workspace \
            -w /workspace \
            solanalabs/solana:v1.18.18 \
            bash -lc '\
              set -euo pipefail; \
              echo "Working directory: $(pwd)"; \
              # build each program (adjust path if you have multiple programs) \
              if [ -d "programs/swapback_cnft" ]; then \
                cd programs/swapback_cnft; \
                echo "Running cargo build-sbf for programs/swapback_cnft"; \
                cargo build-sbf 2>&1 | tee ../../build.log || true; \
              else \
                echo "ERROR: programs/swapback_cnft not found"; exit 1; \
              fi; \
            '

      - name: Upload build.log artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log

# End workflow
