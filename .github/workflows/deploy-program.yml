name: Deploy Solana Program to Devnet

on:
  workflow_dispatch:
    inputs:
      program_name:
        description: 'Programme Ã  dÃ©ployer'
        required: true
        default: 'swapback_cnft'
        type: choice
        options:
          - swapback_cnft
          - swapback_router

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    env:
      SOLANA_CLI_VERSION: 1.18.18
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          profile: minimal

      - name: Cache Cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache target directory
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Install Solana CLI
        run: |
          sh -c "$(curl -sSfL https://release.solana.com/v${{ env.SOLANA_CLI_VERSION }}/install)"
          
      - name: Add Solana to PATH
        run: echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
          
      - name: Verify installations
        run: |
          solana --version
          rustc --version
          cargo --version

      - name: Verify declare_id
        run: |
          PROGRAM_FILE="programs/${{ github.event.inputs.program_name }}/src/lib.rs"
          CURRENT_ID=$(grep 'declare_id!' "$PROGRAM_FILE" | grep -o '"[^"]*"' | tr -d '"')
          echo "Program ID in source: $CURRENT_ID"
          
          if [ "${{ github.event.inputs.program_name }}" = "swapback_cnft" ]; then
            EXPECTED_ID="26kzow1KF3AbrbFA7M3WxXVCtcMRgzMXkAKtVYDDt6Ru"
          else
            EXPECTED_ID="9JD7nuXd5wiyvT6VWnHxWK5VvYAFSG98huNvsDvPwLUg"
          fi
          
          if [ "$CURRENT_ID" != "$EXPECTED_ID" ]; then
            echo "âŒ ERROR: declare_id! mismatch!"
            echo "Expected: $EXPECTED_ID"
            echo "Found: $CURRENT_ID"
            exit 1
          fi
          echo "âœ… declare_id! is correct"

      - name: Build program
        run: |
          cd programs/${{ github.event.inputs.program_name }}
          cargo build-sbf
          cd ../..
          ls -lh target/deploy/

      - name: Display build info
        run: |
          BINARY="target/deploy/${{ github.event.inputs.program_name }}.so"
          KEYPAIR="target/deploy/${{ github.event.inputs.program_name }}-keypair.json"
          
          echo "ğŸ“¦ Binary size: $(du -h $BINARY | cut -f1)"
          echo "ğŸ”‘ Program ID: $(solana-keygen pubkey $KEYPAIR)"

      - name: Setup Solana wallet
        run: |
          echo "${{ secrets.SOLANA_DEPLOYER_PRIVATE_KEY }}" > /tmp/deployer-keypair.json
          solana config set --keypair /tmp/deployer-keypair.json
          solana config set --url devnet

      - name: Check wallet balance
        run: |
          WALLET_ADDRESS=$(solana address)
          BALANCE=$(solana balance --url devnet | awk '{print $1}')
          
          echo "ğŸ’¼ Wallet: $WALLET_ADDRESS"
          echo "ğŸ’° Balance: $BALANCE SOL"

      - name: Deploy program
        run: |
          PROGRAM_ID=$(solana-keygen pubkey target/deploy/${{ github.event.inputs.program_name }}-keypair.json)
          
          echo "ğŸš€ Deploying ${{ github.event.inputs.program_name }} to devnet..."
          echo "ğŸ“ Program ID: $PROGRAM_ID"
          
          solana program deploy \
            --url devnet \
            --program-id target/deploy/${{ github.event.inputs.program_name }}-keypair.json \
            target/deploy/${{ github.event.inputs.program_name }}.so

      - name: Verify deployment
        run: |
          PROGRAM_ID=$(solana-keygen pubkey target/deploy/${{ github.event.inputs.program_name }}-keypair.json)
          
          echo "ğŸ” Verifying deployment..."
          solana program show $PROGRAM_ID --url devnet
          
          echo ""
          echo "âœ… Program deployed successfully!"
          echo "ğŸ“ Program ID: $PROGRAM_ID"
          echo "ğŸŒ Explorer: https://explorer.solana.com/address/$PROGRAM_ID?cluster=devnet"

      - name: Cleanup
        if: always()
        run: |
          rm -f /tmp/deployer-keypair.json
