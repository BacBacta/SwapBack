name: Deploy Solana Program to Devnet

on:
  workflow_dispatch:
    inputs:
      program_name:
        description: 'Programme √† d√©ployer'
        required: true
        default: 'swapback_cnft'
        type: choice
        options:
          - swapback_cnft
          - swapback_router

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config build-essential libudev-dev libssl-dev

      - name: Install Solana CLI (with retry)
        run: |
          max_attempts=3
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts"
            
            if curl -sSfL https://release.solana.com/v1.18.18/install | sh; then
              echo "Solana CLI installed successfully"
              echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
              break
            else
              echo "Installation failed, waiting 30 seconds before retry..."
              sleep 30
              attempt=$((attempt + 1))
              
              if [ $attempt -gt $max_attempts ]; then
                echo "Failed to install Solana CLI after $max_attempts attempts"
                exit 1
              fi
            fi
          done

      - name: Verify Solana installation
        run: |
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          solana --version
          solana-keygen --version
          echo "Solana installed successfully"

      - name: Cache Solana
        uses: actions/cache@v3
        with:
          path: |
            ~/.local/share/solana/
            ~/.cache/solana/
          key: solana-1.18.18-${{ runner.os }}
          restore-keys: |
            solana-1.18.18-

      - name: Verify declare_id in source
        run: |
          PROGRAM_FILE="programs/${{ github.event.inputs.program_name }}/src/lib.rs"
          
          if [ ! -f "$PROGRAM_FILE" ]; then
            echo "‚ùå ERROR: Program file not found: $PROGRAM_FILE"
            exit 1
          fi
          
          CURRENT_ID=$(grep 'declare_id!' "$PROGRAM_FILE" | grep -o '"[^"]*"' | tr -d '"')
          echo "Program ID in source: $CURRENT_ID"
          
          if [ "${{ github.event.inputs.program_name }}" = "swapback_cnft" ]; then
            EXPECTED_ID="26kzow1KF3AbrbFA7M3WxXVCtcMRgzMXkAKtVYDDt6Ru"
          else
            EXPECTED_ID="9JD7nuXd5wiyvT6VWnHxWK5VvYAFSG98huNvsDvPwLUg"
          fi
          
          if [ "$CURRENT_ID" != "$EXPECTED_ID" ]; then
            echo "‚ùå ERROR: declare_id! mismatch!"
            echo "Expected: $EXPECTED_ID"
            echo "Found: $CURRENT_ID"
            exit 1
          fi
          
          echo "‚úÖ declare_id! is correct: $CURRENT_ID"

      - name: Build Solana program
        run: |
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          
          echo "Building program: ${{ github.event.inputs.program_name }}"
          cd programs/${{ github.event.inputs.program_name }}
          
          # Build with cargo-build-sbf
          cargo build-sbf --verbose
          
          cd ../..
          
          # Verify build artifacts
          BINARY="target/deploy/${{ github.event.inputs.program_name }}.so"
          KEYPAIR="target/deploy/${{ github.event.inputs.program_name }}-keypair.json"
          
          if [ ! -f "$BINARY" ]; then
            echo "‚ùå ERROR: Binary not found: $BINARY"
            exit 1
          fi
          
          if [ ! -f "$KEYPAIR" ]; then
            echo "‚ùå ERROR: Keypair not found: $KEYPAIR"
            exit 1
          fi
          
          echo "‚úÖ Build successful"
          ls -lh target/deploy/

      - name: Display build info
        run: |
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          
          BINARY="target/deploy/${{ github.event.inputs.program_name }}.so"
          KEYPAIR="target/deploy/${{ github.event.inputs.program_name }}-keypair.json"
          
          echo "üì¶ Binary: $BINARY"
          echo "üì¶ Size: $(du -h $BINARY | cut -f1)"
          echo "üîë Keypair: $KEYPAIR"
          echo "üîë Program ID: $(solana-keygen pubkey $KEYPAIR)"

      - name: Setup Solana wallet
        run: |
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          
          # Check if secret exists
          if [ -z "${{ secrets.SOLANA_DEPLOYER_PRIVATE_KEY }}" ]; then
            echo "‚ùå ERROR: SOLANA_DEPLOYER_PRIVATE_KEY secret not configured"
            echo "Please add your deployer keypair to GitHub Secrets"
            exit 1
          fi
          
          # Create temporary keypair file
          echo "${{ secrets.SOLANA_DEPLOYER_PRIVATE_KEY }}" > /tmp/deployer-keypair.json
          
          # Validate keypair format
          if ! solana-keygen verify $(solana-keygen pubkey /tmp/deployer-keypair.json) /tmp/deployer-keypair.json; then
            echo "‚ùå ERROR: Invalid keypair format"
            rm -f /tmp/deployer-keypair.json
            exit 1
          fi
          
          # Configure Solana CLI
          solana config set --keypair /tmp/deployer-keypair.json
          solana config set --url devnet
          
          echo "‚úÖ Wallet configured"

      - name: Check wallet and balance
        run: |
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          
          WALLET_ADDRESS=$(solana address)
          echo "üíº Deployer wallet: $WALLET_ADDRESS"
          
          # Get balance
          BALANCE=$(solana balance --url devnet 2>&1 | awk '{print $1}')
          echo "üí∞ Current balance: $BALANCE SOL"
          
          # Check if balance is sufficient (need at least 0.5 SOL)
          BALANCE_NUM=$(echo "$BALANCE" | sed 's/[^0-9.]//g')
          if [ -z "$BALANCE_NUM" ]; then
            echo "‚ö†Ô∏è Could not determine balance, attempting airdrop..."
            solana airdrop 2 --url devnet || echo "Airdrop failed, will try to deploy anyway"
          elif (( $(echo "$BALANCE_NUM < 0.5" | bc -l 2>/dev/null || echo "0") )); then
            echo "‚ö†Ô∏è Low balance, requesting airdrop..."
            solana airdrop 2 --url devnet || echo "Airdrop failed"
            sleep 5
            BALANCE=$(solana balance --url devnet | awk '{print $1}')
            echo "üí∞ New balance: $BALANCE SOL"
          fi

      - name: Verify upgrade authority
        run: |
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          
          PROGRAM_ID=$(solana-keygen pubkey target/deploy/${{ github.event.inputs.program_name }}-keypair.json)
          WALLET_ADDRESS=$(solana address)
          
          echo "Checking upgrade authority for program: $PROGRAM_ID"
          
          # Try to get program info
          PROGRAM_INFO=$(solana program show $PROGRAM_ID --url devnet 2>&1 || echo "")
          
          if echo "$PROGRAM_INFO" | grep -q "Account does not exist"; then
            echo "‚ö†Ô∏è Program not yet deployed (first deployment)"
            echo "FIRST_DEPLOY=true" >> $GITHUB_ENV
          else
            CURRENT_AUTHORITY=$(echo "$PROGRAM_INFO" | grep "Authority:" | awk '{print $2}')
            echo "Current authority: $CURRENT_AUTHORITY"
            echo "Deployer wallet: $WALLET_ADDRESS"
            
            if [ "$WALLET_ADDRESS" != "$CURRENT_AUTHORITY" ]; then
              echo "‚ùå ERROR: Wallet does not have upgrade authority"
              echo "Expected authority: $CURRENT_AUTHORITY"
              echo "Your wallet: $WALLET_ADDRESS"
              exit 1
            fi
            
            echo "‚úÖ Upgrade authority verified"
            echo "FIRST_DEPLOY=false" >> $GITHUB_ENV
          fi

      - name: Deploy program to devnet
        run: |
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          
          PROGRAM_ID=$(solana-keygen pubkey target/deploy/${{ github.event.inputs.program_name }}-keypair.json)
          
          echo "üöÄ Deploying program: ${{ github.event.inputs.program_name }}"
          echo "üìç Program ID: $PROGRAM_ID"
          echo "üåê Network: devnet"
          
          if [ "${{ env.FIRST_DEPLOY }}" = "true" ]; then
            echo "üìù This is a first-time deployment"
          else
            echo "üîÑ This is an upgrade"
          fi
          
          # Deploy with detailed output
          solana program deploy \
            --url devnet \
            --program-id target/deploy/${{ github.event.inputs.program_name }}-keypair.json \
            --upgrade-authority /tmp/deployer-keypair.json \
            target/deploy/${{ github.event.inputs.program_name }}.so \
            --verbose
          
          echo "‚úÖ Deployment successful!"

      - name: Verify deployment
        run: |
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          
          PROGRAM_ID=$(solana-keygen pubkey target/deploy/${{ github.event.inputs.program_name }}-keypair.json)
          
          echo "üîç Verifying deployment..."
          solana program show $PROGRAM_ID --url devnet
          
          echo ""
          echo "‚úÖ Program successfully deployed!"
          echo "üìç Program ID: $PROGRAM_ID"
          echo "üåê Explorer: https://explorer.solana.com/address/$PROGRAM_ID?cluster=devnet"
          echo "üîó Solscan: https://solscan.io/account/$PROGRAM_ID?cluster=devnet"
          
          # Get the last deployed slot
          LAST_SLOT=$(solana program show $PROGRAM_ID --url devnet | grep "Last Deployed Slot:" | awk '{print $4}')
          echo "‚è∞ Last Deployed Slot: $LAST_SLOT"

      - name: Cleanup sensitive files
        if: always()
        run: |
          rm -f /tmp/deployer-keypair.json
          echo "üßπ Cleaned up temporary files"

      - name: Summary
        if: success()
        run: |
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          PROGRAM_ID=$(solana-keygen pubkey target/deploy/${{ github.event.inputs.program_name }}-keypair.json)
          
          echo "## ‚úÖ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Program:** \`${{ github.event.inputs.program_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Program ID:** \`$PROGRAM_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "**Network:** devnet" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Wait 30-60 seconds for network propagation" >> $GITHUB_STEP_SUMMARY
          echo "2. Test on https://swap-back-pc5qkn6em-bactas-projects.vercel.app/" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify that \`DeclaredProgramIdMismatch\` error is gone" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Solana Explorer](https://explorer.solana.com/address/$PROGRAM_ID?cluster=devnet)" >> $GITHUB_STEP_SUMMARY
          echo "- [Solscan](https://solscan.io/account/$PROGRAM_ID?cluster=devnet)" >> $GITHUB_STEP_SUMMARY
          
          echo "üîç Verifying deployment..."
          solana program show $PROGRAM_ID --url devnet
          
          echo ""
          echo "‚úÖ Program deployed successfully!"
          echo "üìç Program ID: $PROGRAM_ID"
          echo "üåê Explorer: https://explorer.solana.com/address/$PROGRAM_ID?cluster=devnet"

      - name: Cleanup
        if: always()
        run: |
          rm -f /tmp/deployer-keypair.json
