name: Build and Deploy CNFT Program

on:
  workflow_dispatch:
    inputs:
      deploy_to_devnet:
        description: 'Deploy to devnet after build?'
        required: true
        type: boolean
        default: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: 1.76.0
        override: true
        profile: minimal
        components: rustfmt, clippy
    
    - name: Install Solana
      run: |
        # Try official installer first
        if curl --retry 5 --retry-delay 2 -sSfL https://release.solana.com/v1.18.26/install -o /tmp/solana-install.sh; then
          sh /tmp/solana-install.sh
        else
          # Fallback: download tarball directly
          echo "Installer failed, trying direct download..."
          cd /tmp
          wget https://github.com/solana-labs/solana/releases/download/v1.18.26/solana-release-x86_64-unknown-linux-gnu.tar.bz2
          tar -xjf solana-release-x86_64-unknown-linux-gnu.tar.bz2
          mkdir -p $HOME/.local/share/solana/install
          mv solana-release $HOME/.local/share/solana/install/active_release
        fi
        echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        solana --version
    
    - name: Install Anchor
      run: |
        cargo install --git https://github.com/coral-xyz/anchor --tag v0.30.1 anchor-cli --locked --force
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        anchor --version
    
    - name: Patch cargo-build-sbf Rust to 1.76.0
      run: |
        set -euo pipefail
        RUST_176_DIR="$HOME/.rustup/toolchains/1.76.0-x86_64-unknown-linux-gnu"

        if [ ! -d "$RUST_176_DIR" ]; then
          echo "::error::Rust 1.76.0 toolchain not found at $RUST_176_DIR"
          exit 1
        fi

        PATCH_DIRS=()
        PRIMARY_DIR="$HOME/.local/share/solana/install/active_release/bin/sdk/sbf/dependencies/platform-tools/rust"

        if [ -d "$PRIMARY_DIR" ] || [ -L "$PRIMARY_DIR" ]; then
          PATCH_DIRS+=("$PRIMARY_DIR")
        fi

        CACHE_ROOT="$HOME/.cache/solana"
        if [ -d "$CACHE_ROOT" ]; then
          while IFS= read -r dir; do
            if [ -n "$dir" ]; then
              PATCH_DIRS+=("$dir")
            fi
          done < <(find "$CACHE_ROOT" -maxdepth 3 -type d -path "*/platform-tools/rust")
        fi

        if [ ${#PATCH_DIRS[@]} -eq 0 ]; then
          echo "::warning::No platform-tools Rust directories detected. cargo-build-sbf may download them later."
        fi

        for dir in "${PATCH_DIRS[@]}"; do
          if [ -z "$dir" ]; then
            continue
          fi

          echo "ðŸ”„ Replacing platform-tools Rust toolchain at $dir"
          rm -rf "$dir"
          mkdir -p "$dir"
          cp -a "$RUST_176_DIR/." "$dir/"
          chmod -R +x "$dir/bin" || true
          "$dir/bin/rustc" --version || true
        done

        cargo-build-sbf --version || true
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Build CNFT Program
      env:
        RUSTUP_TOOLCHAIN: 1.76.0
      run: |
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        export PATH="$HOME/.cargo/bin:$PATH"
        rustc --version
        cargo --version
        anchor --version
        solana --version
        cargo-build-sbf --version
        echo "Building with Rust 1.76.0..."
        anchor build -p swapback_cnft --skip-lint
        ls -lh target/deploy/swapback_cnft.so
    
    - name: Setup Solana Keypair
      if: ${{ inputs.deploy_to_devnet }}
      run: |
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        mkdir -p ~/.config/solana
        echo "${{ secrets.SOLANA_DEVNET_KEYPAIR }}" > ~/.config/solana/id.json
        chmod 600 ~/.config/solana/id.json
        solana config set --url devnet
        solana address
        solana balance
    
    - name: Deploy to Devnet
      if: ${{ inputs.deploy_to_devnet }}
      run: |
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        export PATH="$HOME/.cargo/bin:$PATH"
        solana airdrop 2 --url devnet || true
        anchor deploy -p swapback_cnft --provider.cluster devnet
        echo "DEPLOYMENT_SIGNATURE=$(solana program show DHfa77Z9yCtVtg9GivhbjF1od25PWfwNBCm7ws5eXpzf --url devnet | grep 'Last Deployed' | awk '{print $4}')" >> $GITHUB_ENV
    
    - name: Update IDL
      if: ${{ inputs.deploy_to_devnet }}
      run: |
        cp target/idl/swapback_cnft.json app/src/idl/
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add app/src/idl/swapback_cnft.json
        git commit -m "chore: Update IDL after program deployment to DHfa77Z9yCtVtg9GivhbjF1od25PWfwNBCm7ws5eXpzf" || echo "No changes to commit"
        git push
    
    - name: Upload program artifact
      uses: actions/upload-artifact@v4
      with:
        name: swapback_cnft
        path: |
          target/deploy/swapback_cnft.so
          target/idl/swapback_cnft.json
    
    - name: Deployment Summary
      if: ${{ inputs.deploy_to_devnet }}
      run: |
        echo "âœ… Program deployed successfully!" >> $GITHUB_STEP_SUMMARY
        echo "Program ID: DHfa77Z9yCtVtg9GivhbjF1od25PWfwNBCm7ws5eXpzf" >> $GITHUB_STEP_SUMMARY
        echo "View on Solana Explorer: https://explorer.solana.com/address/DHfa77Z9yCtVtg9GivhbjF1od25PWfwNBCm7ws5eXpzf?cluster=devnet" >> $GITHUB_STEP_SUMMARY
