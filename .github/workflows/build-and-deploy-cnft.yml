name: Build and Deploy CNFT Program

on:
  workflow_dispatch:
    inputs:
      deploy_to_devnet:
        description: 'Deploy to devnet after build?'
        required: true
        type: boolean
        default: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: 1.78.0
        override: true
        profile: minimal
        components: rustfmt, clippy
    
    - name: Install Solana
      run: |
        # Try official installer first
        if curl --retry 5 --retry-delay 2 -sSfL https://release.solana.com/v1.18.26/install -o /tmp/solana-install.sh; then
          sh /tmp/solana-install.sh
        else
          # Fallback: download tarball directly
          echo "Installer failed, trying direct download..."
          cd /tmp
          wget https://github.com/solana-labs/solana/releases/download/v1.18.26/solana-release-x86_64-unknown-linux-gnu.tar.bz2
          tar -xjf solana-release-x86_64-unknown-linux-gnu.tar.bz2
          mkdir -p $HOME/.local/share/solana/install
          mv solana-release $HOME/.local/share/solana/install/active_release
        fi
        echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        solana --version
    
    - name: Install Anchor
      run: |
        cargo install --git https://github.com/coral-xyz/anchor --tag v0.30.1 anchor-cli --locked --force
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        anchor --version
    
    - name: Configure cargo-build-sbf
      run: |
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        # Pré-télécharger les platform-tools
        cargo-build-sbf --version || true
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Build CNFT Program
      env:
        RUSTUP_TOOLCHAIN: 1.78.0
      run: |
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        export PATH="$HOME/.cargo/bin:$PATH"
        echo "=== Environment Check ==="
        rustc --version
        cargo --version
        anchor --version
        solana --version
        cargo-build-sbf --version
        echo ""
        echo "=== Building CNFT Program ==="
        cd /home/runner/work/SwapBack/SwapBack
        anchor build -p swapback_cnft --skip-lint
        echo ""
        echo "=== Build Artifacts ==="
        ls -lh target/deploy/swapback_cnft.so
    
    - name: Setup Solana Keypair
      if: ${{ inputs.deploy_to_devnet }}
      run: |
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        mkdir -p ~/.config/solana
        echo "${{ secrets.SOLANA_DEVNET_KEYPAIR }}" > ~/.config/solana/id.json
        chmod 600 ~/.config/solana/id.json
        solana config set --url devnet
        solana address
        solana balance
    
    - name: Deploy to Devnet
      if: ${{ inputs.deploy_to_devnet }}
      run: |
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        export PATH="$HOME/.cargo/bin:$PATH"
        solana airdrop 2 --url devnet || true
        anchor deploy -p swapback_cnft --provider.cluster devnet
        echo "DEPLOYMENT_SIGNATURE=$(solana program show CzxpYBeKbcA6AJH7yz8ggkJ1cWen3ejKUuikE6stHEaF --url devnet | grep 'Last Deployed' | awk '{print $4}')" >> $GITHUB_ENV
    
    - name: Update IDL
      if: ${{ inputs.deploy_to_devnet }}
      run: |
        cp target/idl/swapback_cnft.json app/src/idl/
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add app/src/idl/swapback_cnft.json
        git commit -m "chore: Update IDL after program deployment to CzxpYBeKbcA6AJH7yz8ggkJ1cWen3ejKUuikE6stHEaF" || echo "No changes to commit"
        git push
    
    - name: Upload program artifact
      uses: actions/upload-artifact@v4
      with:
        name: swapback_cnft
        path: |
          target/deploy/swapback_cnft.so
          target/idl/swapback_cnft.json
    
    - name: Deployment Summary
      if: ${{ inputs.deploy_to_devnet }}
      run: |
        echo "✅ Program deployed successfully!" >> $GITHUB_STEP_SUMMARY
        echo "Program ID: CzxpYBeKbcA6AJH7yz8ggkJ1cWen3ejKUuikE6stHEaF" >> $GITHUB_STEP_SUMMARY
        echo "View on Solana Explorer: https://explorer.solana.com/address/CzxpYBeKbcA6AJH7yz8ggkJ1cWen3ejKUuikE6stHEaF?cluster=devnet" >> $GITHUB_STEP_SUMMARY
