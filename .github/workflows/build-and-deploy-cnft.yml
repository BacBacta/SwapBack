name: Build and Deploy CNFT Program

on:
  workflow_dispatch:
    inputs:
      deploy_to_devnet:
        description: 'Deploy to devnet after build?'
        required: true
        type: boolean
        default: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: 1.79.0
        override: true
        profile: minimal
    
    - name: Install Solana
      run: |
        sh -c "$(curl -sSfL https://release.solana.com/v1.18.26/install)"
        echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
    
    - name: Install Anchor
      run: |
        cargo install --git https://github.com/coral-xyz/anchor --tag v0.30.1 anchor-cli --locked --force
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Build CNFT Program
      run: |
        anchor build -p swapback_cnft
        ls -lh target/deploy/swapback_cnft.so
    
    - name: Setup Solana Keypair
      if: ${{ inputs.deploy_to_devnet }}
      run: |
        echo "${{ secrets.SOLANA_DEVNET_KEYPAIR }}" > ~/.config/solana/id.json
        chmod 600 ~/.config/solana/id.json
        solana config set --url devnet
        solana address
        solana balance
    
    - name: Deploy to Devnet
      if: ${{ inputs.deploy_to_devnet }}
      run: |
        solana airdrop 2 || true
        anchor deploy -p swapback_cnft --provider.cluster devnet
        echo "DEPLOYMENT_SIGNATURE=$(solana program show DHfa77Z9yCtVtg9GivhbjF1od25PWfwNBCm7ws5eXpzf --url devnet | grep 'Last Deployed' | awk '{print $4}')" >> $GITHUB_ENV
    
    - name: Update IDL
      if: ${{ inputs.deploy_to_devnet }}
      run: |
        cp target/idl/swapback_cnft.json app/src/idl/
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add app/src/idl/swapback_cnft.json
        git commit -m "chore: Update IDL after program deployment to DHfa77Z9yCtVtg9GivhbjF1od25PWfwNBCm7ws5eXpzf" || echo "No changes to commit"
        git push
    
    - name: Upload program artifact
      uses: actions/upload-artifact@v4
      with:
        name: swapback_cnft
        path: |
          target/deploy/swapback_cnft.so
          target/idl/swapback_cnft.json
    
    - name: Deployment Summary
      if: ${{ inputs.deploy_to_devnet }}
      run: |
        echo "âœ… Program deployed successfully!" >> $GITHUB_STEP_SUMMARY
        echo "Program ID: DHfa77Z9yCtVtg9GivhbjF1od25PWfwNBCm7ws5eXpzf" >> $GITHUB_STEP_SUMMARY
        echo "View on Solana Explorer: https://explorer.solana.com/address/DHfa77Z9yCtVtg9GivhbjF1od25PWfwNBCm7ws5eXpzf?cluster=devnet" >> $GITHUB_STEP_SUMMARY
