# üöÄ SwapBack - Roadmap Strat√©gique 2025
**Status:** ‚úÖ Tests E2E 12/12 | Buyback System Valid√©  
**Derni√®re mise √† jour:** 31 Octobre 2025

---

## üìä Vue d'Ensemble

```
PHASE 1          PHASE 2           PHASE 3          PHASE 4
[ACTUEL]         [1-2 SEM]         [2-3 SEM]        [1 SEM]
   ‚îÇ                ‚îÇ                 ‚îÇ               ‚îÇ
   ‚îú‚îÄ Tests OK     ‚îú‚îÄ Dashboard      ‚îú‚îÄ Audit        ‚îú‚îÄ Mainnet
   ‚îú‚îÄ Devnet ‚úÖ    ‚îú‚îÄ UX Polish      ‚îú‚îÄ Load Tests   ‚îú‚îÄ Liquidit√©
   ‚îî‚îÄ E2E Pass     ‚îî‚îÄ Analytics      ‚îî‚îÄ Monitoring   ‚îî‚îÄ Launch
```

---

## üéØ PHASE 1 : Int√©gration Buyback (URGENT - 3-5 jours)

### üî¥ **T√¢che #1 : Auto-Deposit 25% Fees USDC**
**Priority:** P0 - Critique  
**Estimation:** 1-2 jours  
**Assign√© √†:** Core Team

#### Objectif
Apr√®s chaque swap r√©ussi, d√©poser automatiquement 25% des fees USDC collect√©es dans le buyback vault.

#### Impl√©mentation

**1. Modifier SwapExecutor (`app/src/lib/swapExecutor.ts`)**
```typescript
import { Program, AnchorProvider, BN } from '@coral-xyz/anchor';

async function executeSwapWithBuyback(params: SwapParams) {
  // 1. Ex√©cuter le swap
  const swapResult = await executeSwap(params);
  
  // 2. Calculer 25% des fees
  const feeAmount = Math.floor(swapResult.fee * 0.25);
  
  // 3. Si montant suffisant, d√©poser dans buyback vault
  if (feeAmount >= 1_000_000) { // Min 1 USDC
    try {
      const buybackSig = await depositToBuybackVault(
        params.wallet,
        new BN(feeAmount)
      );
      console.log(`‚úÖ Buyback deposit: ${buybackSig}`);
    } catch (error) {
      console.error('‚ö†Ô∏è Buyback deposit failed:', error);
      // Non-bloquant : le swap a r√©ussi quand m√™me
    }
  }
  
  return {
    ...swapResult,
    buybackDeposit: feeAmount >= 1_000_000 ? feeAmount : null,
  };
}

async function depositToBuybackVault(wallet, amount: BN) {
  const program = await loadBuybackProgram();
  
  return await program.methods
    .depositUsdc(amount)
    .accounts({
      buybackState: BUYBACK_STATE_PDA,
      userUsdcAccount: await getAssociatedTokenAddress(
        USDC_MINT,
        wallet.publicKey
      ),
      usdcVault: USDC_VAULT_PDA,
      user: wallet.publicKey,
      tokenProgram: TOKEN_PROGRAM_ID,
    })
    .rpc();
}
```

**2. Mettre √† jour l'API Route (`app/src/app/api/execute/route.ts`)**
```typescript
export async function POST(request: Request) {
  const { serializedTransaction, wallet } = await request.json();
  
  // Ex√©cuter swap avec buyback
  const result = await executeSwapWithBuyback({
    transaction: deserializeTransaction(serializedTransaction),
    wallet,
  });
  
  return Response.json({
    signature: result.signature,
    fee: result.fee,
    buybackDeposit: result.buybackDeposit, // Nouveau champ
  });
}
```

**3. Afficher dans l'UI (`app/src/components/SwapInterface.tsx`)**
```typescript
{result.buybackDeposit && (
  <div className="mt-2 p-2 bg-green-50 rounded">
    <p className="text-sm text-green-700">
      ‚úÖ {(result.buybackDeposit / 1e6).toFixed(2)} USDC d√©pos√©s pour le buyback
    </p>
  </div>
)}
```

#### Tests
**Cr√©er:** `tests/e2e/swap-with-buyback.test.ts`
```typescript
it('should deposit 25% fees to buyback vault after swap', async () => {
  const swapAmount = 100 * 1e6; // 100 USDC
  const expectedFee = swapAmount * 0.003; // 0.3 USDC (0.3% fee)
  const expectedDeposit = expectedFee * 0.25; // 0.075 USDC
  
  const vaultBefore = await getVaultBalance();
  await executeSwap({ amount: swapAmount });
  const vaultAfter = await getVaultBalance();
  
  expect(vaultAfter - vaultBefore).toBeCloseTo(expectedDeposit, 0.01);
});
```

#### Crit√®res d'Acceptation
- [ ] 25% des fees automatiquement d√©pos√©es
- [ ] Transaction non-bloquante (√©chec buyback n'affecte pas le swap)
- [ ] Logs clairs dans console & UI
- [ ] Tests E2E passent
- [ ] Documentation mise √† jour

---

### üü° **T√¢che #2 : Dashboard Buyback Temps R√©el**
**Priority:** P1 - Important  
**Estimation:** 2-3 jours  
**Assign√© √†:** Frontend Team

#### Objectif
Cr√©er une page `/buyback` avec statistiques live du syst√®me de buyback.

#### Structure de Fichiers
```bash
app/src/app/buyback/
‚îú‚îÄ‚îÄ page.tsx                      # Page principale
‚îú‚îÄ‚îÄ layout.tsx                    # Layout avec navigation
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ BuybackStats.tsx          # Cartes statistiques
‚îÇ   ‚îú‚îÄ‚îÄ BuybackProgressBar.tsx    # Barre de progression vers seuil
‚îÇ   ‚îú‚îÄ‚îÄ BuybackChart.tsx          # Graphique historique
‚îÇ   ‚îú‚îÄ‚îÄ ExecuteBuybackButton.tsx  # Bouton ex√©cution manuelle
‚îÇ   ‚îî‚îÄ‚îÄ RecentBuybacks.tsx        # Liste derniers buybacks
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ useBuybackState.ts        # Hook lecture on-chain state
‚îÇ   ‚îú‚îÄ‚îÄ useBuybackHistory.ts      # Hook historique transactions
‚îÇ   ‚îî‚îÄ‚îÄ useExecuteBuyback.ts      # Hook ex√©cution buyback
‚îî‚îÄ‚îÄ utils/
    ‚îî‚îÄ‚îÄ buybackFormatters.ts      # Formatters (USDC, $BACK, etc.)
```

#### Composant Principal (`page.tsx`)
```typescript
export default function BuybackPage() {
  const { buybackState, isLoading } = useBuybackState();
  const { history } = useBuybackHistory();
  
  if (isLoading) return <BuybackSkeleton />;
  
  return (
    <div className="container mx-auto p-6">
      <h1 className="text-3xl font-bold mb-6">
        üí∞ Buyback Dashboard
      </h1>
      
      {/* Statistiques principales */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <BuybackStats
          totalUsdcSpent={buybackState.totalUsdcSpent}
          totalBackBurned={buybackState.totalBackBurned}
          buybackCount={buybackState.buybackCount}
        />
      </div>
      
      {/* Progression vers prochain buyback */}
      <BuybackProgressBar
        currentBalance={buybackState.vaultBalance}
        threshold={buybackState.minBuybackAmount}
      />
      
      {/* Bouton ex√©cution si seuil atteint */}
      {buybackState.canExecute && (
        <ExecuteBuybackButton />
      )}
      
      {/* Graphique historique */}
      <BuybackChart data={history} />
      
      {/* Liste derniers buybacks */}
      <RecentBuybacks buybacks={history.slice(0, 10)} />
    </div>
  );
}
```

#### Hook `useBuybackState.ts`
```typescript
import { useConnection } from '@solana/wallet-adapter-react';
import { useQuery } from '@tanstack/react-query';

const BUYBACK_STATE_PDA = new PublicKey('74N3kmNZiRSJCFaYBFjmiQGMwv8vx3aJvMMKJECLNUNM');

export function useBuybackState() {
  const { connection } = useConnection();
  
  const { data, isLoading, error } = useQuery({
    queryKey: ['buyback-state'],
    queryFn: async () => {
      const accountInfo = await connection.getAccountInfo(BUYBACK_STATE_PDA);
      if (!accountInfo) throw new Error('Buyback state not found');
      
      const data = accountInfo.data;
      return {
        authority: new PublicKey(data.slice(8, 40)),
        backMint: new PublicKey(data.slice(40, 72)),
        usdcVault: new PublicKey(data.slice(72, 104)),
        minBuybackAmount: new BN(data.slice(104, 112), 'le').toNumber() / 1e6,
        totalUsdcSpent: new BN(data.slice(112, 120), 'le').toNumber() / 1e6,
        totalBackBurned: new BN(data.slice(120, 128), 'le').toNumber() / 1e9,
        buybackCount: new BN(data.slice(128, 136), 'le').toNumber(),
      };
    },
    refetchInterval: 10_000, // Refresh toutes les 10s
  });
  
  // Fetch vault balance s√©par√©ment
  const { data: vaultBalance } = useQuery({
    queryKey: ['vault-balance'],
    queryFn: async () => {
      const balance = await connection.getTokenAccountBalance(USDC_VAULT_PDA);
      return balance.value.uiAmount || 0;
    },
    refetchInterval: 10_000,
  });
  
  return {
    buybackState: data ? { ...data, vaultBalance, canExecute: vaultBalance >= data.minBuybackAmount } : null,
    isLoading,
    error,
  };
}
```

#### Composant `ExecuteBuybackButton.tsx`
```typescript
export function ExecuteBuybackButton() {
  const wallet = useWallet();
  const { executeBuyback, isPending } = useExecuteBuyback();
  
  return (
    <button
      onClick={() => executeBuyback({ usdcAmount: 5_000_000 })}
      disabled={isPending || !wallet.connected}
      className="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg"
    >
      {isPending ? 'Ex√©cution...' : 'üî• Execute Buyback'}
    </button>
  );
}
```

#### Crit√®res d'Acceptation
- [ ] Page `/buyback` accessible et responsive
- [ ] Stats rafra√Æchies toutes les 10s
- [ ] Graphique √©volution sur 30 jours
- [ ] Bouton "Execute Buyback" fonctionnel
- [ ] Animations & skeleton loaders
- [ ] Tests unitaires composants

---

## üü¢ PHASE 2 : Optimisations & UX (1-2 semaines)

### **T√¢che #3 : Price Impact Calculator**
Afficher l'impact estim√© du buyback sur le prix $BACK.

**Formule:**
```
Price Impact (%) = (buyback_usdc / total_liquidity) * 100
New Price = current_price * (1 + price_impact)
```

### **T√¢che #4 : Notification System**
Toast notifications pour:
- ‚úÖ Swap r√©ussi
- ‚úÖ Buyback deposit effectu√©
- ‚úÖ Seuil buyback atteint
- ‚ùå Erreur transaction
- ‚ö†Ô∏è Wallet d√©connect√©

**Stack:** `react-hot-toast` + `@radix-ui/react-alert-dialog`

### **T√¢che #5 : Analytics Dashboard**
Tableau de bord admin avec:
- Volume swap 24h / 7j / 30j
- Total fees collect√©es
- Taux de succ√®s transactions
- Distribution tokens par wallet

**Technologies:** 
- `recharts` pour graphiques
- `@tanstack/react-table` pour tableaux
- Helius API pour donn√©es on-chain

---

## üîµ PHASE 3 : Production Readiness (2-3 semaines)

### **T√¢che #6 : Audit S√©curit√©**
**Budget:** 15k-30k USD  
**Dur√©e:** 2-3 semaines  
**Prestataires:**
- OtterSec (https://osec.io) - Sp√©cialiste Solana
- Sec3 (https://www.sec3.dev) - Audit Anchor
- Trail of Bits - Audit g√©n√©ral

**Scope:**
- Smart contracts (buyback, router, cNFT)
- Permissions & authority checks
- Reentrancy protection
- Integer overflow/underflow
- Token-2022 hooks
- MEV resistance

### **T√¢che #7 : Tests de Charge**
**Sc√©narios:**
```bash
# Test 1: Swaps simultan√©s
- 100 users √ó 10 swaps = 1000 transactions
- V√©rifier: Taux de succ√®s > 95%

# Test 2: API Stress
- 1000 req/min sur /api/quote
- V√©rifier: Latency p95 < 500ms

# Test 3: Buyback Marathon
- 50 buybacks cons√©cutifs
- V√©rifier: Pas de leak m√©moire

# Test 4: Frontend Load
- 10k users simultan√©s sur UI
- V√©rifier: Time to Interactive < 2s
```

**Outils:**
- `k6` (https://k6.io)
- `artillery` (https://artillery.io)
- `Lighthouse CI` pour performances frontend

### **T√¢che #8 : Monitoring Production**
**Stack:**
- **APM:** Datadog ou New Relic
- **Errors:** Sentry
- **Logs:** Logtail (Better Stack)
- **Uptime:** UptimeRobot
- **Blockchain:** Helius webhooks

**Alertes:**
- üö® Taux d'erreur > 5%
- üö® Latency p95 > 5s
- üö® Vault USDC < 10 USDC
- üö® Programme Anchor errors
- ‚ö†Ô∏è Wallet balance < 0.1 SOL

---

## üü£ PHASE 4 : D√©ploiement Mainnet (1 semaine)

### **Jour 1-2 : Pr√©paration**
- [ ] Audit compl√©t√© + fixes appliqu√©s
- [ ] Tests de charge valid√©s
- [ ] Monitoring configur√©
- [ ] Documentation compl√®te
- [ ] Budget SOL (~5 SOL pour d√©ploiements)
- [ ] Budget USDC (~10k pour liquidit√©)

### **Jour 3 : D√©ploiement Programmes**
```bash
# Build programmes
anchor build --verifiable

# Deploy buyback
anchor deploy --provider.cluster mainnet \
  --program-name swapback_buyback

# Deploy router
anchor deploy --provider.cluster mainnet \
  --program-name swapback_router

# V√©rification
solana program show <PROGRAM_ID> --url mainnet
```

### **Jour 4 : Initialisation**
```bash
# Initialize buyback state
npx tsx scripts/initialize-buyback-mainnet.ts

# Create USDC vault
npx tsx scripts/create-usdc-vault-mainnet.ts

# Verify state
npx tsx scripts/verify-deployment-mainnet.ts
```

### **Jour 5-7 : Beta Priv√©e**
- 50 early adopters s√©lectionn√©s
- Max swap: 100 USDC/tx
- Monitoring 24/7
- Feedback collection

### **Jour 8-14 : Beta Publique**
- Ouverture √† tous
- Max swap: 1000 USDC/tx
- Communication Twitter/Discord
- Bug bounty lanc√©

### **Jour 15+ : Lancement Complet**
- Suppression limites swap
- Marketing campaign
- Partenariats DEX/Wallets
- CEX listings ($BACK)

---

## üìã Checklist Imm√©diate (48h)

### Frontend
- [ ] Cr√©er `/app/src/app/buyback/page.tsx`
- [ ] Cr√©er hook `useBuybackState.ts`
- [ ] Cr√©er hook `useExecuteBuyback.ts`
- [ ] Ajouter route navigation "Buyback" dans header
- [ ] Tester sur devnet

### Backend
- [ ] Modifier `swapExecutor.ts` ‚Üí fonction `depositToBuybackVault()`
- [ ] Modifier API `/api/execute` ‚Üí ajouter champ `buybackDeposit`
- [ ] Cr√©er tests E2E `swap-with-buyback.test.ts`
- [ ] Mettre √† jour `.env` avec addresses mainnet (pr√©paration)

### Documentation
- [ ] Mettre √† jour `README.md` avec section Buyback
- [ ] Cr√©er `docs/BUYBACK_SYSTEM.md` avec sch√©mas
- [ ] Documenter API routes dans Swagger
- [ ] Cr√©er guide utilisateur `/docs/USER_GUIDE.md`

---

## üìä KPIs & M√©triques de Succ√®s

### Techniques
| M√©trique | Cible | Actuel | Status |
|----------|-------|--------|--------|
| Tests E2E | 100% | ‚úÖ 12/12 | üü¢ |
| Code Coverage | >80% | ~75% | üü° |
| Latency Swap (p95) | <2s | ~1.5s | üü¢ |
| Uptime API | >99.9% | - | ‚è≥ |
| Error Rate | <1% | - | ‚è≥ |

### Business (Post-Launch)
| M√©trique | Mois 1 | Mois 3 | Mois 6 |
|----------|--------|--------|--------|
| Volume Swap | $100k | $500k | $2M |
| Total $BACK Burned | 1M | 10M | 50M |
| Utilisateurs Actifs | 500 | 2k | 10k |
| TVL cNFT Locks | $50k | $250k | $1M |

---

## üé¨ Conclusion

**Status actuel:** ‚úÖ Foundation solide  
**Prochaine milestone:** Dashboard Buyback (5 jours)  
**Target mainnet:** D√©but D√©cembre 2025  

**Questions urgentes:**
1. Budget audit s√©curit√© approuv√© ? (15-30k USD)
2. √âquipe frontend disponible pour dashboard ?
3. Plan marketing post-launch d√©fini ?

---

**Derni√®re mise √† jour:** 31 Octobre 2025  
**Commit:** `774841e`  
**Contact:** bacbacta@users.noreply.github.com
